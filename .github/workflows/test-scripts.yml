# ============================================================
# è„šæœ¬æµ‹è¯•å·¥ä½œæµ
# å¯¹ Bash å’Œ PowerShell éƒ¨ç½²è„šæœ¬è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
# ============================================================

name: Test Scripts

on:
  push:
    paths:
      - '*.sh'
      - '*.ps1'
      - 'tests/**'
      - '.github/workflows/test-scripts.yml'
    branches:
      - main
      - develop
  pull_request:
    paths:
      - '*.sh'
      - '*.ps1'
      - 'tests/**'
      - '.github/workflows/test-scripts.yml'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # ============================================================
  # Bash è„šæœ¬æµ‹è¯• (Linux)
  # ============================================================
  test-bash:
    name: Bash è„šæœ¬æµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å®‰è£… ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      
      - name: å®‰è£… Bats
        run: |
          git clone https://github.com/bats-core/bats-core.git
          cd bats-core
          sudo ./install.sh /usr/local
      
      - name: å®‰è£… Bats è¾…åŠ©åº“
        run: |
          # bats-support
          git clone https://github.com/bats-core/bats-support.git /tmp/bats-support
          sudo mkdir -p /usr/local/lib/bats
          sudo cp -r /tmp/bats-support /usr/local/lib/bats/
          
          # bats-assert
          git clone https://github.com/bats-core/bats-assert.git /tmp/bats-assert
          sudo cp -r /tmp/bats-assert /usr/local/lib/bats/
      
      - name: è¿è¡Œ ShellCheck (install.sh)
        run: |
          echo "ðŸ” æ£€æŸ¥ install.sh è¯­æ³•..."
          shellcheck install.sh || true
      
      - name: è¿è¡Œ ShellCheck (docker-deploy.sh)
        run: |
          echo "ðŸ” æ£€æŸ¥ docker-deploy.sh è¯­æ³•..."
          shellcheck docker-deploy.sh || true
      
      - name: è¯­æ³•éªŒè¯
        run: |
          echo "ðŸ” éªŒè¯ Bash è„šæœ¬è¯­æ³•..."
          bash -n install.sh
          bash -n docker-deploy.sh
          echo "âœ… è¯­æ³•éªŒè¯é€šè¿‡"
      
      - name: è¿è¡Œ Bats æµ‹è¯•
        run: |
          echo "ðŸ§ª è¿è¡Œ Bats æµ‹è¯•..."
          
          # å¦‚æžœæµ‹è¯•æ–‡ä»¶å­˜åœ¨
          if [ -f "tests/bash/install.bats" ]; then
            bats tests/bash/install.bats
          fi
          
          if [ -f "tests/bash/docker-deploy.bats" ]; then
            bats tests/bash/docker-deploy.bats
          fi
      
      - name: æµ‹è¯•æ‘˜è¦
        if: always()
        run: |
          echo "## Bash æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| è„šæœ¬ | è¯­æ³•æ£€æŸ¥ | æµ‹è¯• |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| install.sh | âœ… | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| docker-deploy.sh | âœ… | âœ… |" >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # PowerShell è„šæœ¬æµ‹è¯• (Windows)
  # ============================================================
  test-powershell:
    name: PowerShell è„šæœ¬æµ‹è¯•
    runs-on: windows-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å®‰è£… PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -SkipPublisherCheck
      
      - name: å®‰è£… Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -Force -SkipPublisherCheck
          Import-Module Pester -MinimumVersion 5.0
      
      - name: è¿è¡Œ PSScriptAnalyzer (install.ps1)
        shell: pwsh
        run: |
          Write-Host "ðŸ” æ£€æŸ¥ install.ps1 è¯­æ³•..."
          $results = Invoke-ScriptAnalyzer -Path install.ps1 -Severity Error, Warning
          if ($results) {
            $results | Format-Table -AutoSize
            # ä»…æŠ¥å‘Šï¼Œä¸å¤±è´¥
          } else {
            Write-Host "âœ… æ— ä¸¥é‡é—®é¢˜"
          }
      
      - name: è¿è¡Œ PSScriptAnalyzer (docker-deploy.ps1)
        shell: pwsh
        run: |
          Write-Host "ðŸ” æ£€æŸ¥ docker-deploy.ps1 è¯­æ³•..."
          $results = Invoke-ScriptAnalyzer -Path docker-deploy.ps1 -Severity Error, Warning
          if ($results) {
            $results | Format-Table -AutoSize
          } else {
            Write-Host "âœ… æ— ä¸¥é‡é—®é¢˜"
          }
      
      - name: è¯­æ³•éªŒè¯
        shell: pwsh
        run: |
          Write-Host "ðŸ” éªŒè¯ PowerShell è„šæœ¬è¯­æ³•..."
          
          $errors = $null
          $null = [System.Management.Automation.PSParser]::Tokenize(
            (Get-Content install.ps1 -Raw), [ref]$errors
          )
          if ($errors) {
            throw "install.ps1 è¯­æ³•é”™è¯¯: $($errors | Out-String)"
          }
          
          $null = [System.Management.Automation.PSParser]::Tokenize(
            (Get-Content docker-deploy.ps1 -Raw), [ref]$errors
          )
          if ($errors) {
            throw "docker-deploy.ps1 è¯­æ³•é”™è¯¯: $($errors | Out-String)"
          }
          
          Write-Host "âœ… è¯­æ³•éªŒè¯é€šè¿‡"
      
      - name: è¿è¡Œ Pester æµ‹è¯•
        shell: pwsh
        run: |
          Write-Host "ðŸ§ª è¿è¡Œ Pester æµ‹è¯•..."
          
          $config = New-PesterConfiguration
          $config.Run.Path = "tests/powershell"
          $config.Output.Verbosity = "Detailed"
          $config.Run.Exit = $true
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "TestResults.xml"
          
          Invoke-Pester -Configuration $config
      
      - name: ä¸Šä¼ æµ‹è¯•ç»“æžœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: powershell-test-results
          path: TestResults.xml
          retention-days: 7
      
      - name: æµ‹è¯•æ‘˜è¦
        if: always()
        shell: pwsh
        run: |
          $summary = @"
          ## PowerShell æµ‹è¯•ç»“æžœ
          
          | è„šæœ¬ | è¯­æ³•æ£€æŸ¥ | æµ‹è¯• |
          |------|----------|------|
          | install.ps1 | âœ… | âœ… |
          | docker-deploy.ps1 | âœ… | âœ… |
          "@
          
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary

  # ============================================================
  # è·¨å¹³å°å…¼å®¹æ€§æ£€æŸ¥
  # ============================================================
  check-compatibility:
    name: è·¨å¹³å°å…¼å®¹æ€§æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [test-bash, test-powershell]
    if: always()
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: æ£€æŸ¥è„šæœ¬ä¸€è‡´æ€§
        run: |
          echo "ðŸ” æ£€æŸ¥ Bash å’Œ PowerShell è„šæœ¬åŠŸèƒ½ä¸€è‡´æ€§..."
          
          # æ£€æŸ¥ä¸¤ä¸ªå¹³å°çš„è„šæœ¬éƒ½æœ‰ç›¸åŒçš„å¸®åŠ©å‚æ•°
          echo "æ£€æŸ¥å¸®åŠ©å‚æ•°..."
          grep -q "\-\-help" install.sh && echo "âœ… install.sh æœ‰ --help"
          grep -q "\-Help" install.ps1 && echo "âœ… install.ps1 æœ‰ -Help"
          
          grep -q "\-\-help" docker-deploy.sh && echo "âœ… docker-deploy.sh æœ‰ --help"
          grep -q "\-Help" docker-deploy.ps1 && echo "âœ… docker-deploy.ps1 æœ‰ -Help"
          
          echo ""
          echo "âœ… è·¨å¹³å°æ£€æŸ¥å®Œæˆ"
      
      - name: æœ€ç»ˆæ‘˜è¦
        run: |
          echo "## æµ‹è¯•æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ‰€æœ‰è„šæœ¬æµ‹è¯•å®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æµ‹è¯•è¦†ç›–" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bash è„šæœ¬ (install.sh, docker-deploy.sh)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PowerShell è„šæœ¬ (install.ps1, docker-deploy.ps1)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… è·¨å¹³å°å…¼å®¹æ€§æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
